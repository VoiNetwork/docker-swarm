#!/bin/bash

function abort() {
  echo "$1"
  exit 1
}

function get_profile() {
    local voi_home="${HOME}/voi"
    if [ -f "${voi_home}/.profile" ]; then
      source "${voi_home}/.profile"
    else
      abort "Profile not found. Exiting the program."
    fi

    if [ -z "${VOINETWORK_PROFILE}" ]; then
      abort "Profile not found. Exiting the program."
    fi
}

function validate_supported_node_type() {
  if [[ ${VOINETWORK_PROFILE} != "participation" && ${VOINETWORK_PROFILE} != "relay" ]]; then
    abort "This operation is only supported for participation and relay nodes. Exiting the program."
  fi
}

get_profile
validate_supported_node_type

echo "Enable/Disable autoupdate for your node"
echo ""
echo "To enable autoupdate use: set-autoupdate true"
echo "To disable autoupdate use: set-autoupdate false"
echo ""

if [[ -z $1 ]]; then
  echo "Please provide a value for autoupdate"
  exit 1
fi

if [[ $1 != "true" && $1 != "false" ]]; then
  echo "Invalid value for autoupdate. Please use 'true' or 'false'."
  exit 1
fi

if [[ ${VOINETWORK_PROFILE} == "relay" ]]; then
  docker_filename="${HOME}/voi/docker/relay.yml"
else
  docker_filename="${HOME}/voi/docker/compose.yml"
fi

echo "Setting autoupdate to $1 in ${docker_filename}"
sed -i -E "s|(swarm.cronjob.enable=).*|\1$1|" "${docker_filename}"
